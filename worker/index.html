<!doctype html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>TESTING CloudFlare Workers</title>
  <script>
      // Put stuff here to simulate Workers env vars
    let SALT = '1234';
    const BASE = 'http://localhost:8000';
    let KEY = null;
    const USERS = {};
    const LOGIN = {};
  </script>
  <script src="./worker.js"></script>
  <script>


      function randomHex(len_bytes) {
          const arr = new Uint8Array(len_bytes);
          crypto.getRandomValues(arr);
          return Array.from(arr).map(i => i.toString(16)).join('');
      }
    async function saltGen() {
        let current = document.getElementById('salt');
        if (current.value) {
            console.log('Clear salt to generate a new one');
        } else {
            current.value = randomHex(16)
            SALT = current.value;
        }
        return false;
    }

    async function keyGen() {
        let s_key = document.getElementById('signing');
        if (s_key.value) {
            console.log('Clear key to generate a new key.');
        } else {
            let key = await window.crypto.subtle.generateKey(
                {name: "HMAC", hash: {name: "SHA-256"}},
                true, ["sign", "verify"]
            );
            KEY = key;
            jwk = await window.crypto.subtle.exportKey('jwk', key);
            s_key.value = JSON.stringify(jwk);
        }
        return false;
    }

    function updateUsers(newName, newId, newHash) {
        const settings = document.getElementById('settings');
        if (newId in USERS) {
            console.error('user ID collision!')
        } else if (newName in LOGIN) {
            console.error(`user ${newName} already exists!`)
        } else {
            USERS[newId] = newName;
            LOGIN[newName] = newHash;
            txt = `SALT\n${SALT}\n`

            txt += 'USERS:\n'
            txt += JSON.stringify(USERS);
            txt += '\nLOGIN:\n'
            txt += JSON.stringify(LOGIN);
            settings.innerText = txt
        }
    }

    async function newUser() {
        const password = document.getElementById('pass').value;
        const name = document.getElementById('username').value;
        const salt = document.getElementById('salt').value;
        const id = randomHex(4);
        if (salt && name && password) {
            const hash = toHexString(await hashPassword(salt, password))
            console.log(`${id}: ${hash} (${name})`);
            updateUsers(name, id, hash)
        } else {
            console.log('Need a salt, name, and password to add user.')
        }
    }
  </script>
</head>
<body>
<h2>Mind Setup</h2>
<h3>Salt</h3>
<form id="salt_form">
  <input id="salt" type="text" style="width: 30em; font-family: monospace"
         placeholder="Paste an existing salt here, or click generate..">
  <input type="submit" value="Generate">
</form>

<h3>keys</h3>
<form id="keys_form">
  <input id="signing" type="text" style="width: 30em; font-family: monospace"
         placeholder="Paste an existing SIGNING key here, or click generate..">
  <input type="submit" value="Generate">
</form>

<h3>New user</h3>
<form name="newuser" id="newuser">
  <input id="username" placeholder="name" type="text">
  <br>
  <input id="pass" name="password" placeholder="password.." type="password">
  <br>
  <input type="submit" value="Create">
</form>
<h3>Settings</h3>
<div id="settings" style="font-family: monospace; width: calc(100vw - 2rem);
overflow-wrap: break-word; border: 1px solid lightgray; padding: 0.5rem"></div>

<h2>Tests</h2>
<form>
  Cook
</form>
<script async>
  // console.log(handleRequest(new Request('foo.html')));
  // console.log(handleRequest(new Request('foo.html', {headers: {'Cookie': ""}})));
  const loginReq = new Request(BASE + '/login', {
      method: 'POST', // or 'PUT'
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({'user': 'foo', 'password': 'bar'}),
  });
  window.addEventListener('load', async (event) => {
      await handleLogin(loginReq);
  });
</script>
<script>
    document.getElementById("newuser").addEventListener("submit",
        function(evt) {evt.preventDefault(); newUser(); return false;
        });
    document.getElementById("salt_form").addEventListener("submit",
        function(evt) { evt.preventDefault(); saltGen(); return false;
        });
    document.getElementById("keys_form").addEventListener("submit",
        function(evt) { evt.preventDefault(); keyGen(); return false;
        });
    addEventListener('fetch', (event) => {
        console.log(`event ${JSON.stringify(event)}`)
    })
</script>
</body>
</html>
